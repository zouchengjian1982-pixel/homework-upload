<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½œä¸šç®¡ç†åå° - æ•™å¸ˆç«¯</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', sans-serif; background: #f0f2f5; min-height: 100vh; }
        .login-box { max-width: 360px; margin: 100px auto; padding: 40px; background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .login-box h2 { text-align: center; margin-bottom: 30px; color: #667eea; }
        .login-box input { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
        .login-box input:focus { border-color: #667eea; outline: none; }
        .login-box button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; }
        .container { display: none; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 8px 20px; border-radius: 20px; cursor: pointer; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px 30px; }
        .stat-card { background: #fff; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-num { font-size: 36px; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 14px; color: #999; margin-top: 8px; }
        .filters { padding: 0 30px 20px; display: flex; gap: 15px; flex-wrap: wrap; }
        .filters select { padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .table-container { padding: 0 30px 30px; }
        table { width: 100%; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        th { background: #f8f9fa; font-weight: 600; color: #555; font-size: 14px; }
        td { font-size: 14px; color: #333; }
        .status-badge { padding: 5px 12px; border-radius: 15px; font-size: 12px; }
        .status-submitted { background: #e3f2fd; color: #1976d2; }
        .status-reviewed { background: #e8f5e9; color: #388e3c; }
        .action-btn { padding: 6px 15px; border: none; border-radius: 15px; font-size: 12px; cursor: pointer; margin-right: 5px; }
        .btn-view { background: #667eea; color: #fff; }
        .btn-review { background: #4caf50; color: #fff; }
        .btn-delete { background: #f5f5f5; color: #999; }
        .empty { text-align: center; padding: 60px; color: #999; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .modal-header h3 { font-size: 18px; }
        .close-btn { font-size: 24px; cursor: pointer; color: #999; }
        .detail-row { margin-bottom: 15px; }
        .detail-label { font-size: 12px; color: #999; margin-bottom: 5px; }
        .detail-value { font-size: 14px; color: #333; }
        .file-list { margin-top: 15px; }
        .file-item { display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; }
        .file-item span { margin-right: 10px; }
        @media (max-width: 768px) {
            .stats { grid-template-columns: repeat(2, 1fr); }
            .filters { flex-direction: column; }
            table { display: block; overflow-x: auto; }
        }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <div class="login-box" id="loginBox">
        <h2>ğŸ“ æ•™å¸ˆç™»å½•</h2>
        <input type="text" id="username" placeholder="ç”¨æˆ·å">
        <input type="password" id="password" placeholder="å¯†ç ">
        <button onclick="login()">ç™»å½•</button>
    </div>

    <div class="container" id="container">
        <header class="header">
            <h1>ğŸ“š ä½œä¸šç®¡ç†åå°</h1>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </header>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-num" id="totalCount">0</div>
                <div class="stat-label">æ€»æäº¤æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-num" id="todayCount">0</div>
                <div class="stat-label">ä»Šæ—¥æäº¤</div>
            </div>
            <div class="stat-card">
                <div class="stat-num" id="pendingCount">0</div>
                <div class="stat-label">å¾…æ‰¹é˜…</div>
            </div>
            <div class="stat-card">
                <div class="stat-num" id="reviewedCount">0</div>
                <div class="stat-label">å·²æ‰¹é˜…</div>
            </div>
        </div>

        <div class="filters">
            <select id="filterClass" onchange="loadHomeworks()">
                <option value="">å…¨éƒ¨å¹´çº§</option>
                <option value="å…«å¹´çº§(1)ç­">å…«å¹´çº§(1)ç­</option>
                <option value="å…«å¹´çº§(2)ç­">å…«å¹´çº§(2)ç­</option>
                <option value="å…«å¹´çº§(3)ç­">å…«å¹´çº§(3)ç­</option>
                <option value="å…«å¹´çº§(4)ç­">å…«å¹´çº§(4)ç­</option>
                <option value="å…«å¹´çº§(5)ç­">å…«å¹´çº§(5)ç­</option>
                <option value="å…«å¹´çº§(6)ç­">å…«å¹´çº§(6)ç­</option>
                <option value="å…«å¹´çº§(7)ç­">å…«å¹´çº§(7)ç­</option>
                <option value="å…«å¹´çº§(8)ç­">å…«å¹´çº§(8)ç­</option>
                <option value="å…«å¹´çº§(9)ç­">å…«å¹´çº§(9)ç­</option>
                <option value="å…«å¹´çº§(10)ç­">å…«å¹´çº§(10)ç­</option>
                <option value="å…«å¹´çº§(11)ç­">å…«å¹´çº§(11)ç­</option>
                <option value="å…«å¹´çº§(12)ç­">å…«å¹´çº§(12)ç­</option>
            </select>
            <select id="filterSubject" onchange="loadHomeworks()">
                <option value="">å…¨éƒ¨ç§‘ç›®</option>
                <option value="è¯­æ–‡">è¯­æ–‡</option>
                <option value="æ•°å­¦">æ•°å­¦</option>
                <option value="è‹±è¯­">è‹±è¯­</option>
            </select>
            <select id="filterStatus" onchange="loadHomeworks()">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="submitted">å¾…æ‰¹é˜…</option>
                <option value="reviewed">å·²æ‰¹é˜…</option>
            </select>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>å­¦ç”Ÿå§“å</th>
                        <th>å¹´çº§</th>
                        <th>ç§‘ç›®</th>
                        <th>ä½œä¸šæ ‡é¢˜</th>
                        <th>æäº¤æ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="homeworkList"></tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä½œä¸šè¯¦æƒ…</h3>
                <span class="close-btn" onclick="closeDetail()">Ã—</span>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <script>
        const ADMIN_USER = 'teacher';
        const ADMIN_PASS = '123456';

        function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if (u === ADMIN_USER && p === ADMIN_PASS) {
                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('container').style.display = 'block';
                loadHomeworks();
            } else {
                alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
            }
        }

        function logout() {
            document.getElementById('loginBox').style.display = 'block';
            document.getElementById('container').style.display = 'none';
        }

        async function loadHomeworks() {
            let records = [];
            
            // å°è¯•ä»SupabaseåŠ è½½
            try {
                if (typeof supabaseClient !== 'undefined') {
                    const { data, error } = await supabaseClient
                        .from('homework')
                        .select('*')
                        .order('createdAt', { ascending: false });
                    
                    if (!error && data) {
                        records = data;
                        localStorage.setItem('homework_records', JSON.stringify(records));
                    }
                }
            } catch (e) {
                console.log('ä»SupabaseåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', e);
                records = JSON.parse(localStorage.getItem('homework_records')) || [];
            }
            
            if (records.length === 0) {
                records = JSON.parse(localStorage.getItem('homework_records')) || [];
            }
            const filterClass = document.getElementById('filterClass').value;
            const filterSubject = document.getElementById('filterSubject').value;
            const filterStatus = document.getElementById('filterStatus').value;

            if (filterClass) records = records.filter(r => r.className === filterClass);
            if (filterSubject) records = records.filter(r => r.subject === filterSubject);
            if (filterStatus) records = records.filter(r => r.status === filterStatus);

            // ç»Ÿè®¡
            const all = JSON.parse(localStorage.getItem('homework_records')) || [];
            document.getElementById('totalCount').textContent = all.length;
            const today = new Date().toLocaleDateString();
            document.getElementById('todayCount').textContent = all.filter(r => r.submitTime.includes(today.replace(/\//g, '/'))).length;
            document.getElementById('pendingCount').textContent = all.filter(r => r.status === 'submitted').length;
            document.getElementById('reviewedCount').textContent = all.filter(r => r.status === 'reviewed').length;

            const tbody = document.getElementById('homeworkList');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty">æš‚æ— ä½œä¸šè®°å½•</td></tr>';
                return;
            }

            tbody.innerHTML = records.map((r, i) => `
                <tr>
                    <td>${r.studentName}</td>
                    <td>${r.className}</td>
                    <td>${r.subject}</td>
                    <td>${r.homeworkTitle}</td>
                    <td>${r.submitTime}</td>
                    <td><span class="status-badge ${r.status === 'reviewed' ? 'status-reviewed' : 'status-submitted'}">${r.status === 'reviewed' ? 'å·²æ‰¹é˜…' : 'å¾…æ‰¹é˜…'}</span></td>
                    <td>
                        <button class="action-btn btn-view" onclick="viewDetail(${r.id})">æŸ¥çœ‹</button>
                        ${r.status !== 'reviewed' ? `<button class="action-btn btn-review" onclick="markReviewed(${r.id})">æ‰¹é˜…</button>` : ''}
                        <button class="action-btn btn-delete" onclick="deleteRecord(${r.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewDetail(id) {
            const records = JSON.parse(localStorage.getItem('homework_records')) || [];
            const r = records.find(x => x.id === id);
            if (!r) return;

            document.getElementById('detailContent').innerHTML = `
                <div class="detail-row"><div class="detail-label">å­¦ç”Ÿå§“å</div><div class="detail-value">${r.studentName}</div></div>
                <div class="detail-row"><div class="detail-label">å¹´çº§</div><div class="detail-value">${r.className}</div></div>
                <div class="detail-row"><div class="detail-label">ç§‘ç›®</div><div class="detail-value">${r.subject}</div></div>
                <div class="detail-row"><div class="detail-label">ä½œä¸šæ ‡é¢˜</div><div class="detail-value">${r.homeworkTitle}</div></div>
                <div class="detail-row"><div class="detail-label">è¯´æ˜</div><div class="detail-value">${r.description || 'æ— '}</div></div>
                <div class="detail-row"><div class="detail-label">æäº¤æ—¶é—´</div><div class="detail-value">${r.submitTime}</div></div>
                <div class="detail-row"><div class="detail-label">é™„ä»¶ (${r.files.length}ä¸ª)</div>
                    <div class="file-list">${r.files.map(f => `<div class="file-item"><span>ğŸ“</span>${f.name}${f.url ? `<a href="${f.url}" target="_blank" style="margin-left:auto;color:#667eea;">ä¸‹è½½</a>` : ''}</div>`).join('')}</div>
                </div>
            `;
            document.getElementById('detailModal').classList.add('show');
        }

        function closeDetail() {
            document.getElementById('detailModal').classList.remove('show');
        }

        async function markReviewed(id) {
            let records = JSON.parse(localStorage.getItem('homework_records')) || [];
            const r = records.find(x => x.id === id);
            if (r) {
                r.status = 'reviewed';
                localStorage.setItem('homework_records', JSON.stringify(records));
                
                // åŒæ­¥åˆ°Supabase
                try {
                    if (typeof supabaseClient !== 'undefined') {
                        await supabaseClient
                            .from('homework')
                            .update({ status: 'reviewed' })
                            .eq('id', id);
                    }
                } catch (e) {
                    console.log('Supabaseæ›´æ–°å¤±è´¥:', e);
                }
                
                loadHomeworks();
            }
        }

        async function deleteRecord(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤è®°å½•ï¼Ÿ')) return;
            let records = JSON.parse(localStorage.getItem('homework_records')) || [];
            records = records.filter(x => x.id !== id);
            localStorage.setItem('homework_records', JSON.stringify(records));
            
            // ä»Supabaseåˆ é™¤
            try {
                if (typeof supabaseClient !== 'undefined') {
                    await supabaseClient
                        .from('homework')
                        .delete()
                        .eq('id', id);
                }
            } catch (e) {
                console.log('Supabaseåˆ é™¤å¤±è´¥:', e);
            }
            
            loadHomeworks();
        }

        document.getElementById('password').onkeypress = e => { if(e.key==='Enter') login(); };
    </script>
</body>
</html>
